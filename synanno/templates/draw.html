{% extends "templatebase.html" %}

{% block help_content %}
<p class="text-muted">
    The view depicts the "Incorrect" and "Unsure" labeled samples. 
    The top of each card displays the error description, and the image depicts the sample's center slice and corresponding mask. Clicking "Add New Instance" on the bottom of the first card opens the Neuroglancer (NG) and lets you add False Negatives (FN). FNs are added by moving the mouse pointer to the center of the so far undetected instance in the NG and clicking the key "c" (for center). This leaves a yellow marker in the NG. When clicking on review, the corresponding coordinates are depicted and can be manually adjusted. By clicking "Save," a new card is added at the end of the row of cards, marked as "Incorrect" (red), labeled as "False Negative," and only depicting the image.
    Clicking on "Draw Mask" on any of the cards, except the first one, opens an instance-specific module that lets you redraw the mask for the center slice of the instance. After activating the canvas in the draw module, you start tracing the synaptic cleft by setting keypoints through right mouse clicks. After placing at least three key points, the line can be filled - coloring one side in turkeys and one in pink. Clicking "Switch" switches the colors. Moving the lever at the bottom, adjust the thickness of the filled-in line. Clicking "Revise" lets you scrap the created line. This enables you, for example, to split it into two. Pressing "Save" overwrites the existing mask for the center slice with the newly drawn one.
    You can later download the nearly created center slices when clicking "Submit and Finish." Such a newly drawn mask is then named based on the index of the instance, the z value of the middle slice of the instance, and the bounding box.
</p>
{% endblock %}

{% block content %}


<div class="container-fluid content-row mt-5 ">

    <div class="container-fluid py-2">
        <div class="d-flex flex-row flex-nowrap overflow-auto">

            <div class="card border rounded card-body card-body-proof-read text-center"
                style="border-width:4px !important;">
                <h5 class="card-header border-bottom-0 mb-2">False Negative</h5>
                <div class="card-block border-0 p-1 image-card-btn unsure mt-auto" label="Unsure">
                    <div class="main-image-categorize">
                        <img class="img_categorize" src="/static/Images/place_holder_fp.png" width="64px" height="64px">
                    </div>
                </div>
                <div class="card-block mt-2 mt-auto">
                    <div class="col justify-content-center">
                        <button id="add_new_instance" class="btn btn-primary" type="button"
                            data-bs-target="#drawModalFP" data-bs-toggle="modal" data-bs-dismiss="modal">Add New
                            Instance</button>
                    </div>
                </div>
            </div>


            {% for image in images %}

            {% set z1, z2, x1, x2, y1, y2 = image.Adjusted_Bbox %}
            {% set custom_base_path = 'idx_' ~ image.Image_Index ~  '_slice_' ~ image.Middle_Slice ~ '_cor_' ~z1~ '_' ~z2~ '_' ~x1~ '_' ~x2~ '_' ~y1~ '_' ~y2 ~ '.png' %}
            {% set custom_mask_name_curve = 'curve_' ~ custom_base_path %}
            {% set custom_mask_name_circle_pre = 'circlePre_' ~ custom_base_path %}
            {% set custom_mask_name_circle_post = 'circlePost_' ~ custom_base_path %}
            {% set custom_mask_path_check_curve =  './synanno/static/custom_masks/' ~ custom_mask_name_curve %}
            {% set custom_mask_path_check_circle_pre =  './synanno/static/custom_masks/' ~ custom_mask_name_circle_pre %}
            {% set custom_mask_path_check_circle_post =  './synanno/static/custom_masks/' ~ custom_mask_name_circle_post %}
            {% set custom_mask_path_load_curve =  '/static/custom_masks/' ~ custom_mask_name_curve %}
            {% set custom_mask_path_load_circle_pre =  '/static/custom_masks/' ~ custom_mask_name_circle_pre %}
            {% set custom_mask_path_load_circle_post =  '/static/custom_masks/' ~ custom_mask_name_circle_post %}

            <div class="card border rounded card-body card-body-proof-read text-center"
                style="border-width:4px !important;" id="id_error-{{image.Page}}_{{image.Image_Index}}">
                <h5 class="card-header border-bottom-0 mb-2">{{image.Error_Description}}</h5>
                <div class="card-block border-0 p-1 image-card-btn redraw-images {% if image.Label == 'Correct' %}correct{% elif image.Label == 'Incorrect'%}incorrect{% elif image.Label == 'Unsure'%}unsure{% endif %}"
                    page="{{ image.Page }}" data_id="{{ image.Image_Index }}"
                    label="{% if image.Label == 'Correct' %}Correct{% elif image.Label == 'Incorrect'%}Incorrect{% elif image.Label == 'Unsure'%}Unsure{% endif %}">
                    <div class="main-image-categorize">
                        <!-- In case of a FN we depict we use the source image also as the target to act as placholder -->
                        {% if image.Error_Description != "False Negatives"%}
                        <img id="img-target-curve-{{image.Page}}-{{image.Image_Index}}" class="img_categorize"
                            src="{% if os.path.exists(custom_mask_path_check_curve) %} {{custom_mask_path_load_curve}} {% else %} {{ image.GT ~ '/' ~ image.Middle_Slice ~ '.png'}} {% endif %}"
                            width="64px" height="64px" style="opacity: 0.5; ">
                        <img id="img-target-circlePre-{{image.Page}}-{{image.Image_Index}}" class="img_categorize d-none"
                            src="{% if os.path.exists(custom_mask_path_check_circle_pre) %} {{custom_mask_path_load_circle_pre}} {% else %} {{ image.GT ~ '/' ~ image.Middle_Slice ~ '.png'}} {% endif %}"
                            width="64px" height="64px" style="opacity: 0.5; ">
                        <img id="img-target-circlePost-{{image.Page}}-{{image.Image_Index}}" class="img_categorize d-none"
                            src="{% if os.path.exists(custom_mask_path_check_circle_post) %} {{custom_mask_path_load_circle_post}} {% else %} {{ image.GT ~ '/' ~ image.Middle_Slice ~ '.png'}} {% endif %}"
                            width="64px" height="64px" style="opacity: 0.5; ">
                        {% else %}
                        <img id="img-target-curve-{{image.Page}}-{{image.Image_Index}}" class="img_categorize"
                            src="{% if os.path.exists(custom_mask_path_check_curve) %} {{custom_mask_path_load_curve}} {% else %} {{ image.EM ~ '/' ~ image.Middle_Slice ~ '.png'}} {% endif %}"
                            width="64px" height="64px" style="opacity: 0.5; ">
                        <img id="img-target-circlePre-{{image.Page}}-{{image.Image_Index}}" class="img_categorize d-none"
                            src="{% if os.path.exists(custom_mask_path_check_circle_pre) %} {{custom_mask_path_load_circle_pre}} {% else %} {{ image.EM ~ '/' ~ image.Middle_Slice ~ '.png'}} {% endif %}"
                            width="64px" height="64px" style="opacity: 0.5; ">
                        <img id="img-target-circlePost-{{image.Page}}-{{image.Image_Index}}" class="img_categorize d-none"
                            src="{% if os.path.exists(custom_mask_path_check_circle_post) %} {{custom_mask_path_load_circle_post}} {% else %} {{ image.EM ~ '/' ~ image.Middle_Slice ~ '.png'}} {% endif %}"
                            width="64px" height="64px" style="opacity: 0.5; ">
                        {% endif %}
                        <img id="imgGT-{{image.Page}}-{{image.Image_Index}}" class="img_categorize" data-image_base_path="{{ image.EM }}"
                            src="{{ image.EM ~ '/' ~ image.Middle_Slice ~ '.png'}}" width="64px" height="64px">
                    </div>
                </div>
                <div class="card-block mt-2">
                    <div class="col justify-content-center">
                        <button class="btn btn-primary"
                            id="drawButton-{{image.Page}}-{{image.Image_Index}}-{{image.Label}}" type="button"
                            data-bs-target="#drawModal" data-bs-toggle="modal" data-bs-dismiss="modal">Draw
                            Mask</button>
                    </div>
                </div>
            </div>
            {% endfor %}


        </div>
    </div>
    <!-- Show in case no data was detected -->
    <div class="p-5 mb-2 bg-secondary text-white text-center d-none">No instances were marked as faulty!</div>


    <div class="m-4 p-1">
        <a type="button" id="submit_button" class="btn btn-primary {{ modenext }}"
            href="{{ url_for('export_draw') }}">Submit and Finish</a>
    </div>
</div>

<!-- Modal for synapse mask correction -->
{% include "draw_modal.html" %}

<!-- Modal for adding false positve synapses -->
{% include "draw_modal_fp.html" %}

<script src="{{ url_for('static', filename='draw_module.js') }}"></script>

<script src="{{url_for('static', filename='draw.js') }}"></script>

{% endblock %}